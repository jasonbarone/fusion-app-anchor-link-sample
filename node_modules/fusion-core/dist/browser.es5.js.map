{"version":3,"file":"browser.es5.js","sources":["../src/create-plugin.js","../src/create-token.js","../src/tokens.js","../src/sanitization.js","../src/plugins/ssr.js","../src/base-app.js","../src/compose.js","../src/memoize.js","../src/plugins/timing.js","../src/plugins/server-renderer.js","../src/get-env.js","../src/plugins/server-context.js","../src/server-app.js","../src/plugins/client-hydrate.js","../src/plugins/client-renderer.js","../src/client-app.js","../src/virtual/index.js","../src/index.js"],"sourcesContent":["/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport type {FusionPlugin} from './types.js';\n\n// eslint-disable-next-line flowtype/generic-spacing\ntype FusionPluginNoHidden<TDeps, TService> = $Diff<\n  FusionPlugin<TDeps, TService>,\n  {__plugin__: boolean, stack: string}\n>;\n\nexport function createPlugin<TDeps, TService>(\n  opts: $Exact<FusionPluginNoHidden<TDeps, TService>>\n): FusionPlugin<TDeps, TService> {\n  return {\n    __plugin__: true,\n    stack: new Error().stack,\n    ...opts,\n  };\n}\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport type {Token} from './types.js';\n\nexport const TokenType = Object.freeze({\n  Required: 0,\n  Optional: 1,\n});\nfunction Ref() {}\nexport class TokenImpl<TResolved> {\n  name: string;\n  ref: mixed;\n  type: $Values<typeof TokenType>;\n  optional: ?TokenImpl<TResolved>;\n  stacks: Array<{\n    type: 'token' | 'register' | 'enhance' | 'alias-from' | 'alias-to',\n    stack: string,\n  }>;\n\n  constructor(name: string, ref: mixed) {\n    this.name = name;\n    this.ref = ref || new Ref();\n    this.type = ref ? TokenType.Optional : TokenType.Required;\n    this.stacks = [{type: 'token', stack: new Error().stack}];\n    if (!ref) {\n      this.optional = new TokenImpl(name, this.ref);\n    }\n  }\n}\n\nexport function createToken<TResolvedType>(name: string): Token<TResolvedType> {\n  return ((new TokenImpl(name): any): Token<TResolvedType>);\n}\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport {createToken} from './create-token';\nimport type {\n  RenderType,\n  SSRDecider,\n  SSRBodyTemplate,\n  Context,\n} from './types.js';\nimport type {Server} from 'http';\n\nexport const RenderToken = createToken<RenderType>('RenderToken');\nexport const ElementToken = createToken<any>('ElementToken');\nexport const SSRDeciderToken = createToken<SSRDecider>('SSRDeciderToken');\nexport const HttpServerToken = createToken<Server>('HttpServerToken');\nexport const SSRBodyTemplateToken = createToken<SSRBodyTemplate>(\n  'SSRBodyTemplateToken'\n);\nexport const RoutePrefixToken = createToken<string>('RoutePrefixToken');\n\nexport type CriticalChunkIds = Set<number>;\n\nexport type CriticalChunkIdsService = {\n  from(ctx: Context): CriticalChunkIds,\n};\n\nexport const CriticalChunkIdsToken = createToken<CriticalChunkIdsService>(\n  'CriticalChunkIdsToken'\n);\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n/*\nWe never want developers to be able to write `ctx.template.body.push(`<div>${stuff}</div>`)`\nbecause that allows XSS attacks by default (e.g. if stuff === '<script>alert(1)</script>')\nInstead, they should use html`<div>{stuff}</div>` so interpolated data gets automatically escaped\nWe trust the markup outside of interpolation because it's code written by a developer with commit permissions,\nwhich can be audited via code reviews\n*/\n\nimport type {SanitizedHTMLWrapper} from './types.js';\n\n// eslint-disable-next-line import/no-mutable-exports\nlet html, dangerouslySetHTML, consumeSanitizedHTML, escape;\nif (__NODE__) {\n  const forbiddenChars = {\n    '<': '\\\\u003C',\n    '>': '\\\\u003E',\n    '\"': '\\\\u0022',\n    '/': '\\\\u002F',\n    '\\u2028': '\\\\u2028',\n    '\\u2029': '\\\\u2029',\n  };\n  const replaceForbidden = c => forbiddenChars[c];\n\n  const key = Symbol('sanitized html');\n  html = (\n    [head, ...rest]: Array<string>,\n    ...values: Array<string>\n  ): SanitizedHTMLWrapper => {\n    const obj = {};\n    Object.defineProperty(obj, key, {\n      enumerable: false,\n      configurable: false,\n      value: head + values.map((s, i) => escape(s) + rest[i]).join(''),\n    });\n    return obj;\n  };\n  dangerouslySetHTML = (str: string): Object => html([str]);\n  escape = (str: any): string => {\n    if (str && str[key]) return consumeSanitizedHTML(str);\n    return String(str).replace(/[<>\"/\\u2028\\u2029]/g, replaceForbidden);\n  };\n  consumeSanitizedHTML = (h: SanitizedHTMLWrapper): string => {\n    if (typeof h === 'string') {\n      throw new Error(`Unsanitized html. Use html\\`${h}\\``);\n    }\n    return h[key];\n  };\n}\nconst replaceEscaped = c => String.fromCodePoint(parseInt(c.slice(2), 16));\nconst unescape = (str: string): string => {\n  return str.replace(\n    /\\\\u003C|\\\\u003E|\\\\u0022|\\\\u002F|\\\\u2028|\\\\u2029/g,\n    replaceEscaped\n  );\n};\n\n// These types are necessary due to not having an assignment in the __BROWSER__ environment\nconst flowHtml = ((html: any): (\n  strings: Array<string>,\n  ...expressions: Array<string>\n) => SanitizedHTMLWrapper);\n\nconst flowDangerouslySetHTML = ((dangerouslySetHTML: any): (\n  html: string\n) => Object);\n\nconst flowConsumeSanitizedHTML = ((consumeSanitizedHTML: any): (\n  str: SanitizedHTMLWrapper\n) => string);\n\nconst flowEscape = ((escape: any): (str: string) => string);\n\nexport {\n  flowHtml as html,\n  flowDangerouslySetHTML as dangerouslySetHTML,\n  flowConsumeSanitizedHTML as consumeSanitizedHTML,\n  flowEscape as escape,\n  unescape,\n};\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport {createPlugin} from '../create-plugin';\nimport {escape, consumeSanitizedHTML} from '../sanitization';\nimport type {\n  Context,\n  SSRDecider as SSRDeciderService,\n  SSRBodyTemplate as SSRBodyTemplateService,\n} from '../types.js';\n\nconst botRegex = /(bot|crawler|spider)/i;\nconst SSRDecider = createPlugin<{}, SSRDeciderService>({\n  provides: () => {\n    return ctx => {\n      // If the request has one of these extensions, we assume it's not something that requires server-side rendering of virtual dom\n      // TODO(#46): this check should probably look at the asset manifest to ensure asset 404s are handled correctly\n      if (ctx.path.match(/\\.(js|gif|jpg|png|pdf|json)$/)) return false;\n\n      // Bots don't always include the accept header.\n      if (ctx.headers['user-agent']) {\n        const agent = ctx.headers['user-agent'];\n        if (botRegex.test(agent)) {\n          return true;\n        }\n      }\n\n      // The Accept header is a good proxy for whether SSR should happen\n      // Requesting an HTML page via the browser url bar generates a request with `text/html` in its Accept headers\n      // XHR/fetch requests do not have `text/html` in the Accept headers\n      if (!ctx.headers.accept) return false;\n      if (!ctx.headers.accept.includes('text/html')) return false;\n      return true;\n    };\n  },\n});\nexport {SSRDecider};\n\nexport default function createSSRPlugin({\n  element,\n  ssrDecider,\n  ssrBodyTemplate,\n}: {\n  element: any,\n  ssrDecider: SSRDeciderService,\n  ssrBodyTemplate?: SSRBodyTemplateService,\n}) {\n  return async function ssrPlugin(ctx: Context, next: () => Promise<void>) {\n    if (!ssrDecider(ctx)) return next();\n\n    const template = {\n      htmlAttrs: {},\n      bodyAttrs: {},\n      title: '',\n      head: [],\n      body: [],\n    };\n    ctx.element = element;\n    ctx.rendered = '';\n    ctx.template = template;\n    ctx.type = 'text/html';\n\n    await next();\n\n    // Allow someone to override the ssr by setting ctx.body\n    // This is especially useful for things like ctx.redirect\n    if (ctx.body && ctx.respond !== false) {\n      return;\n    }\n\n    if (ssrBodyTemplate) {\n      ctx.body = ssrBodyTemplate(ctx);\n    } else {\n      ctx.body = legacySSRBodyTemplate(ctx);\n    }\n  };\n}\n\nfunction legacySSRBodyTemplate(ctx) {\n  const {htmlAttrs, bodyAttrs, title, head, body} = ctx.template;\n  const safeAttrs = Object.keys(htmlAttrs)\n    .map(attrKey => {\n      return ` ${escape(attrKey)}=\"${escape(htmlAttrs[attrKey])}\"`;\n    })\n    .join('');\n\n  const safeBodyAttrs = Object.keys(bodyAttrs)\n    .map(attrKey => {\n      return ` ${escape(attrKey)}=\"${escape(bodyAttrs[attrKey])}\"`;\n    })\n    .join('');\n\n  const safeTitle = escape(title);\n  const safeHead = head.map(consumeSanitizedHTML).join('');\n  const safeBody = body.map(consumeSanitizedHTML).join('');\n\n  const preloadHintLinks = getPreloadHintLinks(ctx);\n  const coreGlobals = getCoreGlobals(ctx);\n  const chunkScripts = getChunkScripts(ctx);\n  const bundleSplittingBootstrap = [\n    preloadHintLinks,\n    coreGlobals,\n    chunkScripts,\n  ].join('');\n\n  return [\n    '<!doctype html>',\n    `<html${safeAttrs}>`,\n    `<head>`,\n    `<meta charset=\"utf-8\" />`,\n    `<title>${safeTitle}</title>`,\n    `${bundleSplittingBootstrap}${safeHead}`,\n    `</head>`,\n    `<body${safeBodyAttrs}>${ctx.rendered}${safeBody}</body>`,\n    '</html>',\n  ].join('');\n}\n\nfunction getCoreGlobals(ctx) {\n  const {webpackPublicPath, nonce} = ctx;\n\n  return [\n    `<script nonce=\"${nonce}\">`,\n    `window.performance && window.performance.mark && window.performance.mark('firstRenderStart');`,\n    `__ROUTE_PREFIX__ = ${JSON.stringify(ctx.prefix)};`, // consumed by ./client\n    `__WEBPACK_PUBLIC_PATH__ = ${JSON.stringify(webpackPublicPath)};`, // consumed by fusion-clientries/client-entry\n    `</script>`,\n  ].join('');\n}\n\nfunction getUrls({chunkUrlMap, webpackPublicPath}, chunks) {\n  // cross origin is needed to get meaningful errors in window.onerror\n  const isCrossOrigin = webpackPublicPath.startsWith('http');\n  const crossOriginAttribute = isCrossOrigin ? ' crossorigin=\"anonymous\"' : '';\n  return [...new Set(chunks)].map(id => {\n    let url = chunkUrlMap.get(id).get('es5');\n    if (webpackPublicPath.endsWith('/')) {\n      url = webpackPublicPath + url;\n    } else {\n      url = webpackPublicPath + '/' + url;\n    }\n    return {url, crossOriginAttribute};\n  });\n}\n\nfunction getChunkScripts(ctx) {\n  const sync = getUrls(ctx, ctx.syncChunks).map(\n    ({url, crossOriginAttribute}) => {\n      return `<script nonce=\"${\n        ctx.nonce\n      }\" defer${crossOriginAttribute} src=\"${url}\"></script>`;\n    }\n  );\n  const preloaded = getUrls(\n    ctx,\n    ctx.preloadChunks.filter(item => !ctx.syncChunks.includes(item))\n  ).map(({url, crossOriginAttribute}) => {\n    return `<script nonce=\"${\n      ctx.nonce\n    }\" defer${crossOriginAttribute} src=\"${url}\"></script>`;\n  });\n  return [...preloaded, ...sync].join('');\n}\n\nfunction getPreloadHintLinks(ctx) {\n  const chunks = [...ctx.preloadChunks, ...ctx.syncChunks];\n  const hints = getUrls(ctx, chunks).map(({url, crossOriginAttribute}) => {\n    return `<link rel=\"preload\"${crossOriginAttribute} href=\"${url}\" nonce=\"${\n      ctx.nonce\n    }\" as=\"script\" />`;\n  });\n  return hints.join('');\n}\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport {createPlugin} from './create-plugin';\nimport {createToken, TokenType, TokenImpl} from './create-token';\nimport {ElementToken, RenderToken, SSRDeciderToken} from './tokens';\nimport {SSRDecider} from './plugins/ssr';\n\nimport type {aliaser, cleanupFn, FusionPlugin, Token} from './types.js';\n\ninterface Register<T> {\n  (Token<T>, mixed): aliaser<Token<T>>;\n  (mixed): aliaser<Token<T>>;\n}\n\nclass FusionApp {\n  constructor(el: Element | string, render: any => any) {\n    this.registered = new Map(); // getTokenRef(token) -> {value, aliases, enhancers}\n    this.enhancerToToken = new Map(); // enhancer -> token\n    this._dependedOn = new Set();\n    this.plugins = []; // Token\n    this.cleanups = [];\n    el && this.register(ElementToken, el);\n    render && this.register(RenderToken, render);\n    this.register(SSRDeciderToken, SSRDecider);\n  }\n\n  // eslint-disable-next-line\n  registered: Map<\n    any,\n    {\n      aliases?: Map<any, any>,\n      enhancers?: Array<any>,\n      token: any,\n      value?: FusionPlugin<*, *>,\n    }\n  >;\n  enhancerToToken: Map<any, any>;\n  plugins: Array<any>;\n  cleanups: Array<cleanupFn>;\n  renderer: any;\n  _getService: any => any;\n  _dependedOn: Set<any>;\n\n  register: Register<*> = <T>(tokenOrValue, maybeValue) => {\n    const hasToken = tokenOrValue instanceof TokenImpl;\n    const token = hasToken\n      ? ((tokenOrValue: any): Token<T>)\n      : createToken('UnnamedPlugin');\n    const value: any = hasToken ? maybeValue : tokenOrValue;\n    if (!hasToken && (value == null || !value.__plugin__)) {\n      throw new Error(\n        __DEV__\n          ? `Cannot register ${String(\n              tokenOrValue\n            )} without a token. Did you accidentally register a ${\n              __NODE__ ? 'browser' : 'server'\n            } plugin on the ${__NODE__ ? 'server' : 'browser'}?`\n          : 'Invalid configuration registration'\n      );\n    }\n    // the renderer is a special case, since it needs to be always run last\n    if (token === RenderToken) {\n      this.renderer = value;\n      return {\n        alias: () => {\n          throw new Error('Aliasing for RenderToken not supported.');\n        },\n      };\n    }\n    token.stacks.push({type: 'register', stack: new Error().stack});\n    if (value && value.__plugin__) {\n      token.stacks.push({type: 'plugin', stack: value.stack});\n    }\n    return this._register(token, value);\n  };\n  _register<TResolved>(token: Token<TResolved>, value: *) {\n    this.plugins.push(token);\n    const {aliases, enhancers} = this.registered.get(getTokenRef(token)) || {\n      aliases: new Map(),\n      enhancers: [],\n    };\n    if (value && value.__plugin__) {\n      if (value.deps) {\n        Object.values(value.deps).forEach(token =>\n          this._dependedOn.add(getTokenRef(token))\n        );\n      }\n    }\n    this.registered.set(getTokenRef(token), {\n      value,\n      aliases,\n      enhancers,\n      token,\n    });\n    const alias = (sourceToken, destToken) => {\n      const stack = new Error().stack;\n      sourceToken.stacks.push({type: 'alias-from', stack});\n      destToken.stacks.push({type: 'alias-to', stack});\n      this._dependedOn.add(getTokenRef(destToken));\n      if (aliases) {\n        aliases.set(getTokenRef(sourceToken), destToken);\n      }\n      return {alias};\n    };\n    return {alias};\n  }\n  middleware(deps: *, middleware: *) {\n    if (middleware === undefined) {\n      middleware = () => deps;\n    }\n    this.register(createPlugin({deps, middleware}));\n  }\n  enhance<TResolved>(token: Token<TResolved>, enhancer: Function) {\n    token.stacks.push({type: 'enhance', stack: new Error().stack});\n    const {value, aliases, enhancers} = this.registered.get(\n      getTokenRef(token)\n    ) || {\n      aliases: new Map(),\n      enhancers: [],\n      value: undefined,\n    };\n    this.enhancerToToken.set(enhancer, token);\n\n    if (enhancers && Array.isArray(enhancers)) {\n      enhancers.push(enhancer);\n    }\n    this.registered.set(getTokenRef(token), {\n      value,\n      aliases,\n      enhancers,\n      token,\n    });\n  }\n  cleanup() {\n    return Promise.all(this.cleanups.map(fn => fn()));\n  }\n  resolve<TResolved>() {\n    if (!this.renderer) {\n      throw new Error('Missing registration for RenderToken');\n    }\n    this._register(RenderToken, this.renderer);\n    const resolved = new Map(); // Token.ref || Token => Service\n    const nonPluginTokens = new Set(); // Token\n    const resolving = new Set(); // Token.ref || Token\n    const registered = this.registered; // Token.ref || Token -> {value, aliases, enhancers}\n    const resolvedPlugins = []; // Plugins\n    const appliedEnhancers = [];\n    const resolveToken = (token: Token<TResolved>, tokenAliases) => {\n      // Base: if we have already resolved the type, return it\n      if (tokenAliases && tokenAliases.has(getTokenRef(token))) {\n        const newToken = tokenAliases.get(getTokenRef(token));\n        if (newToken) {\n          token = newToken;\n        }\n      }\n      if (resolved.has(getTokenRef(token))) {\n        return resolved.get(getTokenRef(token));\n      }\n\n      // Base: if currently resolving the same type, we have a circular dependency\n      if (resolving.has(getTokenRef(token))) {\n        throw new Error(`Cannot resolve circular dependency: ${token.name}`);\n      }\n\n      // Base: the type was never registered, throw error or provide undefined if optional\n      let {value, aliases, enhancers} =\n        registered.get(getTokenRef(token)) || {};\n      if (value === undefined) {\n        // Attempt to get default value, if optional\n        if (token instanceof TokenImpl && token.type === TokenType.Optional) {\n          this.register(token, undefined);\n        } else {\n          const dependents = Array.from(this.registered.entries());\n\n          /**\n           * Iterate over the entire list of dependencies and find all\n           * dependencies of a given token.\n           */\n          const findDependentTokens = () => {\n            return dependents\n              .filter(entry => {\n                if (!entry[1].value || !entry[1].value.deps) {\n                  return false;\n                }\n                return Object.values(entry[1].value.deps).includes(token);\n              })\n              .map(entry => entry[1].token.name);\n          };\n          const findDependentEnhancers = () => {\n            return appliedEnhancers\n              .filter(([, provides]) => {\n                if (!provides || !provides.deps) {\n                  return false;\n                }\n                return Object.values(provides.deps).includes(token);\n              })\n              .map(([enhancer]) => {\n                const enhancedToken = this.enhancerToToken.get(enhancer);\n                return `EnhancerOf<${\n                  enhancedToken ? enhancedToken.name : '(unknown)'\n                }>`;\n              });\n          };\n          const dependentTokens = [\n            ...findDependentTokens(),\n            ...findDependentEnhancers(),\n          ];\n\n          const base =\n            'A plugin depends on a token, but the token was not registered';\n          const downstreams =\n            'This token is required by plugins registered with tokens: ' +\n            dependentTokens.map(token => `\"${token}\"`).join(', ');\n          const stack = token.stacks.find(t => t.type === 'token');\n          const meta = `Required token: ${\n            token ? token.name : ''\n          }\\n${downstreams}\\n${stack ? stack.stack : ''}`;\n          const clue = 'Different tokens with the same name were detected:\\n\\n';\n          const suggestions = token\n            ? this.plugins\n                .filter(p => p.name === token.name)\n                .map(p => {\n                  const stack = p.stacks.find(t => t.type === 'token');\n                  return `${p.name}\\n${stack ? stack.stack : ''}\\n\\n`;\n                })\n                .join('\\n\\n')\n            : '';\n          const help =\n            'You may have multiple versions of the same plugin installed.\\n' +\n            'Ensure that `yarn list [the-plugin]` results in one version, ' +\n            'and use a yarn resolution or merge package version in your lock file to consolidate versions.\\n\\n';\n          throw new Error(\n            `${base}\\n\\n${meta}\\n\\n${suggestions && clue + suggestions + help}`\n          );\n        }\n      }\n\n      // Recursive: get the registered type and resolve it\n      resolving.add(getTokenRef(token));\n\n      function resolvePlugin(plugin) {\n        const registeredDeps = (plugin && plugin.deps) || {};\n        const resolvedDeps = {};\n        for (const key in registeredDeps) {\n          const registeredToken = registeredDeps[key];\n          resolvedDeps[key] = resolveToken(registeredToken, aliases);\n        }\n        // `provides` should be undefined if the plugin does not have a `provides` function\n        let provides =\n          plugin && plugin.provides ? plugin.provides(resolvedDeps) : undefined;\n        if (plugin && plugin.middleware) {\n          resolvedPlugins.push(plugin.middleware(resolvedDeps, provides));\n        }\n        return provides;\n      }\n\n      let provides = value;\n      if (value && value.__plugin__) {\n        provides = resolvePlugin(provides);\n        if (value.cleanup) {\n          this.cleanups.push(function() {\n            return typeof value.cleanup === 'function'\n              ? value.cleanup(provides)\n              : Promise.resolve();\n          });\n        }\n      } else {\n        nonPluginTokens.add(token);\n      }\n\n      if (enhancers && enhancers.length) {\n        enhancers.forEach(e => {\n          let nextProvides = e(provides);\n          appliedEnhancers.push([e, nextProvides]);\n          if (nextProvides && nextProvides.__plugin__) {\n            // if the token has a plugin enhancer, allow it to be registered with no dependents\n            nonPluginTokens.delete(token);\n            if (nextProvides.deps) {\n              Object.values(nextProvides.deps).forEach(token =>\n                this._dependedOn.add(getTokenRef(token))\n              );\n            }\n            nextProvides = resolvePlugin(nextProvides);\n          }\n          provides = nextProvides;\n        });\n      }\n      resolved.set(getTokenRef(token), provides);\n      resolving.delete(getTokenRef(token));\n      return provides;\n    };\n\n    for (let i = 0; i < this.plugins.length; i++) {\n      resolveToken(this.plugins[i]);\n    }\n    for (const token of nonPluginTokens) {\n      if (\n        token !== ElementToken &&\n        token !== RenderToken &&\n        !this._dependedOn.has(getTokenRef(token))\n      ) {\n        throw new Error(\n          `Registered token without depending on it: \"${token.name}\"`\n        );\n      }\n    }\n\n    this.plugins = resolvedPlugins;\n    this._getService = token => resolved.get(getTokenRef(token));\n  }\n  getService<TResolved>(token: Token<TResolved>): any {\n    if (!this._getService) {\n      throw new Error('Cannot get service from unresolved app');\n    }\n    return this._getService(token);\n  }\n}\n\n/* Helper functions */\nfunction getTokenRef(token) {\n  if (token instanceof TokenImpl) {\n    return token.ref;\n  }\n  return token;\n}\n\nexport default FusionApp;\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport type {Middleware} from './types.js';\n\n// inline version of koa-compose to get around Rollup/CUP commonjs-related issue\nexport function compose(middleware: Array<Middleware>): Middleware {\n  if (!Array.isArray(middleware)) {\n    throw new TypeError('Middleware stack must be an array!');\n  }\n  for (const fn of middleware) {\n    if (typeof fn !== 'function') {\n      throw new TypeError(\n        `Expected middleware function, received: ${typeof fn}`\n      );\n    }\n  }\n\n  return function(context, next) {\n    let index = -1;\n    return dispatch(0);\n    function dispatch(i) {\n      if (i <= index) {\n        return Promise.reject(new Error('next() called multiple times'));\n      }\n      index = i;\n      let fn = middleware[i];\n      if (i === middleware.length) fn = next;\n      if (!fn) return Promise.resolve();\n      try {\n        return fn(context, function next() {\n          return dispatch(i + 1);\n        });\n      } catch (err) {\n        return Promise.reject(err);\n      }\n    }\n  };\n}\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport type {Context} from './types.js';\n\ntype MemoizeFn<A> = (ctx: Context) => A;\n\nfunction Container() {}\n\nexport function memoize<A>(fn: MemoizeFn<A>): MemoizeFn<A> {\n  const memoizeKey = __NODE__ ? Symbol('memoize-key') : new Container();\n  return function memoized(ctx: Context) {\n    if (ctx.memoized.has(memoizeKey)) {\n      return ctx.memoized.get(memoizeKey);\n    }\n    const result = fn(ctx);\n    ctx.memoized.set(memoizeKey, result);\n    return result;\n  };\n}\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\nimport {createPlugin} from '../create-plugin';\nimport {memoize} from '../memoize';\nimport {createToken} from '../create-token';\nimport type {Token} from '../types.js';\n\ntype Deferred<T> = {\n  promise: Promise<T>,\n  resolve: (result: T) => void,\n  reject: (error: Error) => void,\n};\n\nclass Timing {\n  start: number;\n  render: Deferred<number>;\n  end: Deferred<number>;\n  downstream: Deferred<number>;\n  upstream: Deferred<number>;\n  upstreamStart: number;\n  constructor() {\n    this.start = now();\n    this.render = deferred();\n    this.end = deferred();\n    this.downstream = deferred();\n    this.upstream = deferred();\n    this.upstreamStart = -1;\n  }\n}\ntype TimingPlugin = {\n  from(ctx: Object): Timing,\n};\n\nconst timing: TimingPlugin = {\n  from: memoize(() => new Timing()),\n};\n\nexport const TimingToken: Token<TimingPlugin> = createToken('TimingToken');\n\nfunction middleware(ctx, next) {\n  ctx.memoized = new Map();\n  const {start, render, end, downstream, upstream} = timing.from(ctx);\n  ctx.timing = {\n    start,\n    render: render.promise,\n    end: end.promise,\n    downstream: downstream.promise,\n    upstream: upstream.promise,\n  };\n  return next()\n    .then(() => {\n      const upstreamTime = now() - timing.from(ctx).upstreamStart;\n      upstream.resolve(upstreamTime);\n      const endTime = now() - ctx.timing.start;\n      end.resolve(endTime);\n    })\n    .catch(e => {\n      // currently we only resolve upstream and downstream when the request does not error\n      // we should however always resolve the request end timing\n      if (e && e.status) {\n        // this ensures any logging / metrics based on ctx.status will recieve the correct status code\n        ctx.status = e.status;\n      }\n      const endTime = now() - ctx.timing.start;\n      end.resolve(endTime);\n      throw e;\n    });\n}\n\nexport default createPlugin<{}, typeof timing>({\n  provides: () => timing,\n  middleware: () => middleware,\n});\n\nexport function now(): number {\n  if (__NODE__) {\n    const [seconds, ns] = process.hrtime();\n    return Math.round(seconds * 1000 + ns / 1e6);\n  } else {\n    // eslint-disable-next-line cup/no-undef\n    if (window.performance && window.performance.now) {\n      // eslint-disable-next-line cup/no-undef\n      return Math.round(window.performance.now());\n    }\n    return Date.now();\n  }\n}\n\nfunction deferred<T>(): Deferred<T> {\n  let resolve = () => {};\n  let reject = () => {};\n  const promise = new Promise((res, rej) => {\n    resolve = res;\n    reject = rej;\n  });\n  return {\n    promise,\n    resolve,\n    reject,\n  };\n}\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport {now} from './timing';\n\nimport type {Context} from '../types.js';\n\nexport default function getRendererPlugin({\n  render,\n  timing,\n}: {\n  render: any,\n  timing: any,\n}) {\n  return async function renderer(ctx: Context, next: () => Promise<void>) {\n    const timer = timing.from(ctx);\n    timer.downstream.resolve(now() - timer.start);\n\n    let renderTime = null;\n    if (ctx.element && !ctx.body && ctx.respond !== false) {\n      const renderStart = now();\n      ctx.rendered = await render(ctx.element, ctx);\n      renderTime = now() - renderStart;\n    }\n\n    timer.upstreamStart = now();\n    await next();\n\n    if (ctx.element && typeof renderTime === 'number') {\n      timer.render.resolve(renderTime);\n    }\n  };\n}\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n/* eslint-env node */\nimport assert from 'assert';\n\nexport default (__BROWSER__ ? () => {} : loadEnv());\n\nfunction load(key, value) {\n  return process.env[key] || value;\n}\n\nexport function loadEnv() {\n  const rootDir = load('ROOT_DIR', '.');\n  const env = load('NODE_ENV', 'development');\n  if (!(env === 'development' || env === 'production' || env === 'test')) {\n    throw new Error(`Invalid NODE_ENV loaded: ${env}.`);\n  }\n  const prefix = load('ROUTE_PREFIX', '');\n  assert(!prefix.endsWith('/'), 'ROUTE_PREFIX must not end with /');\n  const baseAssetPath = load('FRAMEWORK_STATIC_ASSET_PATH', `/_static`);\n  assert(\n    !baseAssetPath.endsWith('/'),\n    'FRAMEWORK_STATIC_ASSET_PATH must not end with /'\n  );\n  const cdnUrl = load('CDN_URL', '');\n  assert(!cdnUrl.endsWith('/'), 'CDN_URL must not end with /');\n\n  const assetPath = `${prefix}${baseAssetPath}`;\n  return function loadEnv(): Env {\n    return {\n      rootDir,\n      env,\n      prefix,\n      assetPath,\n      baseAssetPath,\n      cdnUrl,\n      webpackPublicPath: cdnUrl || assetPath,\n    };\n  };\n}\n\n// Handle flow-types for export so browser export is ignored.\ntype Env = {\n  rootDir: string,\n  env: string,\n  prefix: string,\n  assetPath: string,\n  baseAssetPath: string,\n  cdnUrl: string,\n  webpackPublicPath: string,\n};\ndeclare export default () => Env;\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport uuidv4 from 'uuid/v4';\nimport UAParser from 'ua-parser-js';\nimport getEnv from '../get-env.js';\n\nimport type {Context} from '../types.js';\n\nconst envVars = getEnv();\n\nexport default function middleware(ctx: Context, next: () => Promise<void>) {\n  // env vars\n  ctx.rootDir = envVars.rootDir;\n  ctx.env = envVars.env;\n  ctx.prefix = envVars.prefix;\n  ctx.assetPath = envVars.assetPath;\n  ctx.cdnUrl = envVars.cdnUrl;\n\n  // webpack-related things\n  ctx.preloadChunks = [];\n  ctx.webpackPublicPath =\n    ctx.webpackPublicPath || envVars.cdnUrl || envVars.assetPath;\n\n  // these are set by fusion-cli, however since fusion-cli plugins are not added when\n  // running simulation tests, it is good to default them here\n  ctx.syncChunks = ctx.syncChunks || [];\n  ctx.chunkUrlMap = ctx.chunkUrlMap || new Map();\n\n  // fusion-specific things\n  ctx.nonce = uuidv4();\n  ctx.useragent = new UAParser(ctx.headers['user-agent']).getResult();\n  ctx.element = null;\n  ctx.rendered = null;\n\n  return next();\n}\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n/* eslint-env node */\nimport {compose} from './compose.js';\nimport Timing, {TimingToken} from './plugins/timing';\nimport BaseApp from './base-app';\nimport serverRenderer from './plugins/server-renderer';\nimport {\n  RenderToken,\n  ElementToken,\n  SSRDeciderToken,\n  SSRBodyTemplateToken,\n} from './tokens';\nimport ssrPlugin from './plugins/ssr';\nimport contextMiddleware from './plugins/server-context.js';\n\nexport default function(): typeof BaseApp {\n  const Koa = require('koa');\n\n  return class ServerApp extends BaseApp {\n    _app: Koa;\n    constructor(el, render) {\n      super(el, render);\n      this._app = new Koa();\n      this._app.proxy = true;\n      this.middleware(contextMiddleware);\n      this.register(TimingToken, Timing);\n      this.middleware(\n        {\n          element: ElementToken,\n          ssrDecider: SSRDeciderToken,\n          ssrBodyTemplate: SSRBodyTemplateToken.optional,\n        },\n        ssrPlugin\n      );\n    }\n    resolve() {\n      this.middleware(\n        {timing: TimingToken, render: RenderToken},\n        serverRenderer\n      );\n      return super.resolve();\n    }\n    callback() {\n      this.resolve();\n      this._app.use(compose(this.plugins));\n      return this._app.callback();\n    }\n  };\n}\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\n/* eslint-env browser */\n\nimport type {Context} from '../types.js';\n\nexport default function createClientHydrate({element}: {element: any}) {\n  return function clientHydrate(ctx: Context, next: () => Promise<void>) {\n    ctx.prefix = window.__ROUTE_PREFIX__ || ''; // serialized by ./server\n    ctx.element = element;\n    ctx.preloadChunks = [];\n    return next();\n  };\n}\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport type {Context} from '../types.js';\n\nexport default function createClientRenderer({render}: {render: any}) {\n  return function renderer(ctx: Context, next: () => Promise<void>) {\n    const rendered = render(ctx.element, ctx);\n    if (rendered instanceof Promise) {\n      return rendered.then(r => {\n        ctx.rendered = r;\n        return next();\n      });\n    } else {\n      ctx.rendered = rendered;\n      return next();\n    }\n  };\n}\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n/* eslint-env browser */\nimport {compose} from './compose.js';\nimport timing, {TimingToken} from './plugins/timing';\nimport BaseApp from './base-app';\nimport createClientHydrate from './plugins/client-hydrate';\nimport createClientRenderer from './plugins/client-renderer';\nimport {RenderToken, ElementToken} from './tokens';\n\nexport default function(): typeof BaseApp {\n  return class ClientApp extends BaseApp {\n    constructor(el, render) {\n      super(el, render);\n      this.register(TimingToken, timing);\n      this.middleware({element: ElementToken}, createClientHydrate);\n    }\n    resolve() {\n      this.middleware({render: RenderToken}, createClientRenderer);\n      return super.resolve();\n    }\n    callback() {\n      this.resolve();\n      const middleware = compose(this.plugins);\n      return () => {\n        // TODO(#62): Create noop context object to match server api\n        const ctx: any = {\n          url: window.location.path + window.location.search,\n          element: null,\n          body: null,\n        };\n        return middleware(ctx, () => Promise.resolve()).then(() => ctx);\n      };\n    }\n  };\n}\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nexport function assetUrl(url: string): string {\n  /**\n   * PLEASE NOTE: a build step transforms\n   * the arguments provided to this function\n   */\n  return url;\n}\n\nexport function chunkId(filename: string): string {\n  /**\n   * PLEASE NOTE: a build step transforms\n   * the arguments provided to this function\n   */\n  return filename;\n}\n\nexport function syncChunkIds(argument: any): any {\n  /**\n   * PLEASE NOTE: a build step transforms\n   * the arguments provided to this function\n   */\n  return argument;\n}\n\nexport function syncChunkPaths(argument: any): any {\n  /**\n   * PLEASE NOTE: a build step transforms\n   * the arguments provided to this function\n   */\n  return argument;\n}\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\nimport type {\n  Context,\n  FusionPlugin,\n  Middleware,\n  Token,\n  SSRBodyTemplate,\n  RenderType as Render,\n} from './types.js';\n\nimport BaseApp from './base-app';\nimport serverApp from './server-app';\nimport clientApp from './client-app';\nimport getEnv from './get-env.js';\n\nexport default (__BROWSER__ ? clientApp() : serverApp());\n\nexport {compose} from './compose.js';\nexport {memoize} from './memoize';\n\n// sanitization API\nexport {\n  html,\n  dangerouslySetHTML,\n  consumeSanitizedHTML,\n  escape,\n  unescape,\n} from './sanitization';\n\n// Virtual modules\nexport {\n  assetUrl,\n  chunkId,\n  syncChunkIds,\n  syncChunkPaths,\n} from './virtual/index.js';\n\nexport {\n  RenderToken,\n  ElementToken,\n  SSRDeciderToken,\n  HttpServerToken,\n  SSRBodyTemplateToken,\n  RoutePrefixToken,\n  CriticalChunkIdsToken,\n} from './tokens';\nexport {createPlugin} from './create-plugin';\nexport {createToken} from './create-token';\nexport {getEnv};\n\ntype FusionApp = typeof BaseApp;\ndeclare export default typeof BaseApp;\nexport type {\n  Context,\n  FusionApp,\n  FusionPlugin,\n  Middleware,\n  Token,\n  SSRBodyTemplate,\n  Render,\n};\n"],"names":["createPlugin","opts","__plugin__","stack","Error","TokenType","Object","freeze","Required","Optional","Ref","TokenImpl","name","ref","type","stacks","optional","createToken","RenderToken","ElementToken","SSRDeciderToken","HttpServerToken","SSRBodyTemplateToken","RoutePrefixToken","CriticalChunkIdsToken","html","dangerouslySetHTML","consumeSanitizedHTML","escape","replaceEscaped","c","String","fromCodePoint","parseInt","slice","unescape","str","replace","flowHtml","flowDangerouslySetHTML","flowConsumeSanitizedHTML","flowEscape","botRegex","SSRDecider","provides","ctx","path","match","headers","agent","test","accept","includes","FusionApp","el","render","register","tokenOrValue","maybeValue","hasToken","token","value","renderer","alias","push","_register","registered","Map","enhancerToToken","_dependedOn","Set","plugins","cleanups","get","getTokenRef","aliases","enhancers","deps","values","forEach","add","set","sourceToken","destToken","middleware","undefined","enhance","enhancer","Array","isArray","cleanup","Promise","all","map","fn","resolve","resolved","nonPluginTokens","resolving","resolvedPlugins","appliedEnhancers","resolveToken","tokenAliases","has","newToken","dependents","from","entries","findDependentTokens","filter","entry","findDependentEnhancers","enhancedToken","dependentTokens","base","downstreams","join","find","t","meta","clue","suggestions","p","help","resolvePlugin","plugin","registeredDeps","resolvedDeps","key","registeredToken","length","e","nextProvides","delete","i","_getService","getService","compose","TypeError","context","next","index","dispatch","reject","err","Container","memoize","memoizeKey","memoized","result","Timing","start","now","deferred","end","downstream","upstream","upstreamStart","timing","TimingToken","promise","then","upstreamTime","endTime","catch","status","window","performance","Math","round","Date","res","rej","createClientHydrate","element","clientHydrate","prefix","__ROUTE_PREFIX__","preloadChunks","createClientRenderer","rendered","r","callback","url","location","search","body","BaseApp","assetUrl","chunkId","filename","syncChunkIds","argument","syncChunkPaths","clientApp"],"mappings":"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"}