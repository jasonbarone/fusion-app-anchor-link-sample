{"version":3,"file":"index.js","sources":["../src/create-plugin.js","../src/create-token.js","../src/tokens.js","../src/sanitization.js","../src/plugins/ssr.js","../src/base-app.js","../src/compose.js","../src/memoize.js","../src/plugins/timing.js","../src/plugins/server-renderer.js","../src/get-env.js","../src/plugins/server-context.js","../src/server-app.js","../src/plugins/client-hydrate.js","../src/plugins/client-renderer.js","../src/client-app.js","../src/virtual/index.js","../src/index.js"],"sourcesContent":["/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport type {FusionPlugin} from './types.js';\n\n// eslint-disable-next-line flowtype/generic-spacing\ntype FusionPluginNoHidden<TDeps, TService> = $Diff<\n  FusionPlugin<TDeps, TService>,\n  {__plugin__: boolean, stack: string}\n>;\n\nexport function createPlugin<TDeps, TService>(\n  opts: $Exact<FusionPluginNoHidden<TDeps, TService>>\n): FusionPlugin<TDeps, TService> {\n  return {\n    __plugin__: true,\n    stack: new Error().stack,\n    ...opts,\n  };\n}\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport type {Token} from './types.js';\n\nexport const TokenType = Object.freeze({\n  Required: 0,\n  Optional: 1,\n});\nfunction Ref() {}\nexport class TokenImpl<TResolved> {\n  name: string;\n  ref: mixed;\n  type: $Values<typeof TokenType>;\n  optional: ?TokenImpl<TResolved>;\n  stacks: Array<{\n    type: 'token' | 'register' | 'enhance' | 'alias-from' | 'alias-to',\n    stack: string,\n  }>;\n\n  constructor(name: string, ref: mixed) {\n    this.name = name;\n    this.ref = ref || new Ref();\n    this.type = ref ? TokenType.Optional : TokenType.Required;\n    this.stacks = [{type: 'token', stack: new Error().stack}];\n    if (!ref) {\n      this.optional = new TokenImpl(name, this.ref);\n    }\n  }\n}\n\nexport function createToken<TResolvedType>(name: string): Token<TResolvedType> {\n  return ((new TokenImpl(name): any): Token<TResolvedType>);\n}\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport {createToken} from './create-token';\nimport type {\n  RenderType,\n  SSRDecider,\n  SSRBodyTemplate,\n  Context,\n} from './types.js';\nimport type {Server} from 'http';\n\nexport const RenderToken = createToken<RenderType>('RenderToken');\nexport const ElementToken = createToken<any>('ElementToken');\nexport const SSRDeciderToken = createToken<SSRDecider>('SSRDeciderToken');\nexport const HttpServerToken = createToken<Server>('HttpServerToken');\nexport const SSRBodyTemplateToken = createToken<SSRBodyTemplate>(\n  'SSRBodyTemplateToken'\n);\nexport const RoutePrefixToken = createToken<string>('RoutePrefixToken');\n\nexport type CriticalChunkIds = Set<number>;\n\nexport type CriticalChunkIdsService = {\n  from(ctx: Context): CriticalChunkIds,\n};\n\nexport const CriticalChunkIdsToken = createToken<CriticalChunkIdsService>(\n  'CriticalChunkIdsToken'\n);\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n/*\nWe never want developers to be able to write `ctx.template.body.push(`<div>${stuff}</div>`)`\nbecause that allows XSS attacks by default (e.g. if stuff === '<script>alert(1)</script>')\nInstead, they should use html`<div>{stuff}</div>` so interpolated data gets automatically escaped\nWe trust the markup outside of interpolation because it's code written by a developer with commit permissions,\nwhich can be audited via code reviews\n*/\n\nimport type {SanitizedHTMLWrapper} from './types.js';\n\n// eslint-disable-next-line import/no-mutable-exports\nlet html, dangerouslySetHTML, consumeSanitizedHTML, escape;\nif (__NODE__) {\n  const forbiddenChars = {\n    '<': '\\\\u003C',\n    '>': '\\\\u003E',\n    '\"': '\\\\u0022',\n    '/': '\\\\u002F',\n    '\\u2028': '\\\\u2028',\n    '\\u2029': '\\\\u2029',\n  };\n  const replaceForbidden = c => forbiddenChars[c];\n\n  const key = Symbol('sanitized html');\n  html = (\n    [head, ...rest]: Array<string>,\n    ...values: Array<string>\n  ): SanitizedHTMLWrapper => {\n    const obj = {};\n    Object.defineProperty(obj, key, {\n      enumerable: false,\n      configurable: false,\n      value: head + values.map((s, i) => escape(s) + rest[i]).join(''),\n    });\n    return obj;\n  };\n  dangerouslySetHTML = (str: string): Object => html([str]);\n  escape = (str: any): string => {\n    if (str && str[key]) return consumeSanitizedHTML(str);\n    return String(str).replace(/[<>\"/\\u2028\\u2029]/g, replaceForbidden);\n  };\n  consumeSanitizedHTML = (h: SanitizedHTMLWrapper): string => {\n    if (typeof h === 'string') {\n      throw new Error(`Unsanitized html. Use html\\`${h}\\``);\n    }\n    return h[key];\n  };\n}\nconst replaceEscaped = c => String.fromCodePoint(parseInt(c.slice(2), 16));\nconst unescape = (str: string): string => {\n  return str.replace(\n    /\\\\u003C|\\\\u003E|\\\\u0022|\\\\u002F|\\\\u2028|\\\\u2029/g,\n    replaceEscaped\n  );\n};\n\n// These types are necessary due to not having an assignment in the __BROWSER__ environment\nconst flowHtml = ((html: any): (\n  strings: Array<string>,\n  ...expressions: Array<string>\n) => SanitizedHTMLWrapper);\n\nconst flowDangerouslySetHTML = ((dangerouslySetHTML: any): (\n  html: string\n) => Object);\n\nconst flowConsumeSanitizedHTML = ((consumeSanitizedHTML: any): (\n  str: SanitizedHTMLWrapper\n) => string);\n\nconst flowEscape = ((escape: any): (str: string) => string);\n\nexport {\n  flowHtml as html,\n  flowDangerouslySetHTML as dangerouslySetHTML,\n  flowConsumeSanitizedHTML as consumeSanitizedHTML,\n  flowEscape as escape,\n  unescape,\n};\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport {createPlugin} from '../create-plugin';\nimport {escape, consumeSanitizedHTML} from '../sanitization';\nimport type {\n  Context,\n  SSRDecider as SSRDeciderService,\n  SSRBodyTemplate as SSRBodyTemplateService,\n} from '../types.js';\n\nconst botRegex = /(bot|crawler|spider)/i;\nconst SSRDecider = createPlugin<{}, SSRDeciderService>({\n  provides: () => {\n    return ctx => {\n      // If the request has one of these extensions, we assume it's not something that requires server-side rendering of virtual dom\n      // TODO(#46): this check should probably look at the asset manifest to ensure asset 404s are handled correctly\n      if (ctx.path.match(/\\.(js|gif|jpg|png|pdf|json)$/)) return false;\n\n      // Bots don't always include the accept header.\n      if (ctx.headers['user-agent']) {\n        const agent = ctx.headers['user-agent'];\n        if (botRegex.test(agent)) {\n          return true;\n        }\n      }\n\n      // The Accept header is a good proxy for whether SSR should happen\n      // Requesting an HTML page via the browser url bar generates a request with `text/html` in its Accept headers\n      // XHR/fetch requests do not have `text/html` in the Accept headers\n      if (!ctx.headers.accept) return false;\n      if (!ctx.headers.accept.includes('text/html')) return false;\n      return true;\n    };\n  },\n});\nexport {SSRDecider};\n\nexport default function createSSRPlugin({\n  element,\n  ssrDecider,\n  ssrBodyTemplate,\n}: {\n  element: any,\n  ssrDecider: SSRDeciderService,\n  ssrBodyTemplate?: SSRBodyTemplateService,\n}) {\n  return async function ssrPlugin(ctx: Context, next: () => Promise<void>) {\n    if (!ssrDecider(ctx)) return next();\n\n    const template = {\n      htmlAttrs: {},\n      bodyAttrs: {},\n      title: '',\n      head: [],\n      body: [],\n    };\n    ctx.element = element;\n    ctx.rendered = '';\n    ctx.template = template;\n    ctx.type = 'text/html';\n\n    await next();\n\n    // Allow someone to override the ssr by setting ctx.body\n    // This is especially useful for things like ctx.redirect\n    if (ctx.body && ctx.respond !== false) {\n      return;\n    }\n\n    if (ssrBodyTemplate) {\n      ctx.body = ssrBodyTemplate(ctx);\n    } else {\n      ctx.body = legacySSRBodyTemplate(ctx);\n    }\n  };\n}\n\nfunction legacySSRBodyTemplate(ctx) {\n  const {htmlAttrs, bodyAttrs, title, head, body} = ctx.template;\n  const safeAttrs = Object.keys(htmlAttrs)\n    .map(attrKey => {\n      return ` ${escape(attrKey)}=\"${escape(htmlAttrs[attrKey])}\"`;\n    })\n    .join('');\n\n  const safeBodyAttrs = Object.keys(bodyAttrs)\n    .map(attrKey => {\n      return ` ${escape(attrKey)}=\"${escape(bodyAttrs[attrKey])}\"`;\n    })\n    .join('');\n\n  const safeTitle = escape(title);\n  const safeHead = head.map(consumeSanitizedHTML).join('');\n  const safeBody = body.map(consumeSanitizedHTML).join('');\n\n  const preloadHintLinks = getPreloadHintLinks(ctx);\n  const coreGlobals = getCoreGlobals(ctx);\n  const chunkScripts = getChunkScripts(ctx);\n  const bundleSplittingBootstrap = [\n    preloadHintLinks,\n    coreGlobals,\n    chunkScripts,\n  ].join('');\n\n  return [\n    '<!doctype html>',\n    `<html${safeAttrs}>`,\n    `<head>`,\n    `<meta charset=\"utf-8\" />`,\n    `<title>${safeTitle}</title>`,\n    `${bundleSplittingBootstrap}${safeHead}`,\n    `</head>`,\n    `<body${safeBodyAttrs}>${ctx.rendered}${safeBody}</body>`,\n    '</html>',\n  ].join('');\n}\n\nfunction getCoreGlobals(ctx) {\n  const {webpackPublicPath, nonce} = ctx;\n\n  return [\n    `<script nonce=\"${nonce}\">`,\n    `window.performance && window.performance.mark && window.performance.mark('firstRenderStart');`,\n    `__ROUTE_PREFIX__ = ${JSON.stringify(ctx.prefix)};`, // consumed by ./client\n    `__WEBPACK_PUBLIC_PATH__ = ${JSON.stringify(webpackPublicPath)};`, // consumed by fusion-clientries/client-entry\n    `</script>`,\n  ].join('');\n}\n\nfunction getUrls({chunkUrlMap, webpackPublicPath}, chunks) {\n  // cross origin is needed to get meaningful errors in window.onerror\n  const isCrossOrigin = webpackPublicPath.startsWith('http');\n  const crossOriginAttribute = isCrossOrigin ? ' crossorigin=\"anonymous\"' : '';\n  return [...new Set(chunks)].map(id => {\n    let url = chunkUrlMap.get(id).get('es5');\n    if (webpackPublicPath.endsWith('/')) {\n      url = webpackPublicPath + url;\n    } else {\n      url = webpackPublicPath + '/' + url;\n    }\n    return {url, crossOriginAttribute};\n  });\n}\n\nfunction getChunkScripts(ctx) {\n  const sync = getUrls(ctx, ctx.syncChunks).map(\n    ({url, crossOriginAttribute}) => {\n      return `<script nonce=\"${\n        ctx.nonce\n      }\" defer${crossOriginAttribute} src=\"${url}\"></script>`;\n    }\n  );\n  const preloaded = getUrls(\n    ctx,\n    ctx.preloadChunks.filter(item => !ctx.syncChunks.includes(item))\n  ).map(({url, crossOriginAttribute}) => {\n    return `<script nonce=\"${\n      ctx.nonce\n    }\" defer${crossOriginAttribute} src=\"${url}\"></script>`;\n  });\n  return [...preloaded, ...sync].join('');\n}\n\nfunction getPreloadHintLinks(ctx) {\n  const chunks = [...ctx.preloadChunks, ...ctx.syncChunks];\n  const hints = getUrls(ctx, chunks).map(({url, crossOriginAttribute}) => {\n    return `<link rel=\"preload\"${crossOriginAttribute} href=\"${url}\" nonce=\"${\n      ctx.nonce\n    }\" as=\"script\" />`;\n  });\n  return hints.join('');\n}\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport {createPlugin} from './create-plugin';\nimport {createToken, TokenType, TokenImpl} from './create-token';\nimport {ElementToken, RenderToken, SSRDeciderToken} from './tokens';\nimport {SSRDecider} from './plugins/ssr';\n\nimport type {aliaser, cleanupFn, FusionPlugin, Token} from './types.js';\n\ninterface Register<T> {\n  (Token<T>, mixed): aliaser<Token<T>>;\n  (mixed): aliaser<Token<T>>;\n}\n\nclass FusionApp {\n  constructor(el: Element | string, render: any => any) {\n    this.registered = new Map(); // getTokenRef(token) -> {value, aliases, enhancers}\n    this.enhancerToToken = new Map(); // enhancer -> token\n    this._dependedOn = new Set();\n    this.plugins = []; // Token\n    this.cleanups = [];\n    el && this.register(ElementToken, el);\n    render && this.register(RenderToken, render);\n    this.register(SSRDeciderToken, SSRDecider);\n  }\n\n  // eslint-disable-next-line\n  registered: Map<\n    any,\n    {\n      aliases?: Map<any, any>,\n      enhancers?: Array<any>,\n      token: any,\n      value?: FusionPlugin<*, *>,\n    }\n  >;\n  enhancerToToken: Map<any, any>;\n  plugins: Array<any>;\n  cleanups: Array<cleanupFn>;\n  renderer: any;\n  _getService: any => any;\n  _dependedOn: Set<any>;\n\n  register: Register<*> = <T>(tokenOrValue, maybeValue) => {\n    const hasToken = tokenOrValue instanceof TokenImpl;\n    const token = hasToken\n      ? ((tokenOrValue: any): Token<T>)\n      : createToken('UnnamedPlugin');\n    const value: any = hasToken ? maybeValue : tokenOrValue;\n    if (!hasToken && (value == null || !value.__plugin__)) {\n      throw new Error(\n        __DEV__\n          ? `Cannot register ${String(\n              tokenOrValue\n            )} without a token. Did you accidentally register a ${\n              __NODE__ ? 'browser' : 'server'\n            } plugin on the ${__NODE__ ? 'server' : 'browser'}?`\n          : 'Invalid configuration registration'\n      );\n    }\n    // the renderer is a special case, since it needs to be always run last\n    if (token === RenderToken) {\n      this.renderer = value;\n      return {\n        alias: () => {\n          throw new Error('Aliasing for RenderToken not supported.');\n        },\n      };\n    }\n    token.stacks.push({type: 'register', stack: new Error().stack});\n    if (value && value.__plugin__) {\n      token.stacks.push({type: 'plugin', stack: value.stack});\n    }\n    return this._register(token, value);\n  };\n  _register<TResolved>(token: Token<TResolved>, value: *) {\n    this.plugins.push(token);\n    const {aliases, enhancers} = this.registered.get(getTokenRef(token)) || {\n      aliases: new Map(),\n      enhancers: [],\n    };\n    if (value && value.__plugin__) {\n      if (value.deps) {\n        Object.values(value.deps).forEach(token =>\n          this._dependedOn.add(getTokenRef(token))\n        );\n      }\n    }\n    this.registered.set(getTokenRef(token), {\n      value,\n      aliases,\n      enhancers,\n      token,\n    });\n    const alias = (sourceToken, destToken) => {\n      const stack = new Error().stack;\n      sourceToken.stacks.push({type: 'alias-from', stack});\n      destToken.stacks.push({type: 'alias-to', stack});\n      this._dependedOn.add(getTokenRef(destToken));\n      if (aliases) {\n        aliases.set(getTokenRef(sourceToken), destToken);\n      }\n      return {alias};\n    };\n    return {alias};\n  }\n  middleware(deps: *, middleware: *) {\n    if (middleware === undefined) {\n      middleware = () => deps;\n    }\n    this.register(createPlugin({deps, middleware}));\n  }\n  enhance<TResolved>(token: Token<TResolved>, enhancer: Function) {\n    token.stacks.push({type: 'enhance', stack: new Error().stack});\n    const {value, aliases, enhancers} = this.registered.get(\n      getTokenRef(token)\n    ) || {\n      aliases: new Map(),\n      enhancers: [],\n      value: undefined,\n    };\n    this.enhancerToToken.set(enhancer, token);\n\n    if (enhancers && Array.isArray(enhancers)) {\n      enhancers.push(enhancer);\n    }\n    this.registered.set(getTokenRef(token), {\n      value,\n      aliases,\n      enhancers,\n      token,\n    });\n  }\n  cleanup() {\n    return Promise.all(this.cleanups.map(fn => fn()));\n  }\n  resolve<TResolved>() {\n    if (!this.renderer) {\n      throw new Error('Missing registration for RenderToken');\n    }\n    this._register(RenderToken, this.renderer);\n    const resolved = new Map(); // Token.ref || Token => Service\n    const nonPluginTokens = new Set(); // Token\n    const resolving = new Set(); // Token.ref || Token\n    const registered = this.registered; // Token.ref || Token -> {value, aliases, enhancers}\n    const resolvedPlugins = []; // Plugins\n    const appliedEnhancers = [];\n    const resolveToken = (token: Token<TResolved>, tokenAliases) => {\n      // Base: if we have already resolved the type, return it\n      if (tokenAliases && tokenAliases.has(getTokenRef(token))) {\n        const newToken = tokenAliases.get(getTokenRef(token));\n        if (newToken) {\n          token = newToken;\n        }\n      }\n      if (resolved.has(getTokenRef(token))) {\n        return resolved.get(getTokenRef(token));\n      }\n\n      // Base: if currently resolving the same type, we have a circular dependency\n      if (resolving.has(getTokenRef(token))) {\n        throw new Error(`Cannot resolve circular dependency: ${token.name}`);\n      }\n\n      // Base: the type was never registered, throw error or provide undefined if optional\n      let {value, aliases, enhancers} =\n        registered.get(getTokenRef(token)) || {};\n      if (value === undefined) {\n        // Attempt to get default value, if optional\n        if (token instanceof TokenImpl && token.type === TokenType.Optional) {\n          this.register(token, undefined);\n        } else {\n          const dependents = Array.from(this.registered.entries());\n\n          /**\n           * Iterate over the entire list of dependencies and find all\n           * dependencies of a given token.\n           */\n          const findDependentTokens = () => {\n            return dependents\n              .filter(entry => {\n                if (!entry[1].value || !entry[1].value.deps) {\n                  return false;\n                }\n                return Object.values(entry[1].value.deps).includes(token);\n              })\n              .map(entry => entry[1].token.name);\n          };\n          const findDependentEnhancers = () => {\n            return appliedEnhancers\n              .filter(([, provides]) => {\n                if (!provides || !provides.deps) {\n                  return false;\n                }\n                return Object.values(provides.deps).includes(token);\n              })\n              .map(([enhancer]) => {\n                const enhancedToken = this.enhancerToToken.get(enhancer);\n                return `EnhancerOf<${\n                  enhancedToken ? enhancedToken.name : '(unknown)'\n                }>`;\n              });\n          };\n          const dependentTokens = [\n            ...findDependentTokens(),\n            ...findDependentEnhancers(),\n          ];\n\n          const base =\n            'A plugin depends on a token, but the token was not registered';\n          const downstreams =\n            'This token is required by plugins registered with tokens: ' +\n            dependentTokens.map(token => `\"${token}\"`).join(', ');\n          const stack = token.stacks.find(t => t.type === 'token');\n          const meta = `Required token: ${\n            token ? token.name : ''\n          }\\n${downstreams}\\n${stack ? stack.stack : ''}`;\n          const clue = 'Different tokens with the same name were detected:\\n\\n';\n          const suggestions = token\n            ? this.plugins\n                .filter(p => p.name === token.name)\n                .map(p => {\n                  const stack = p.stacks.find(t => t.type === 'token');\n                  return `${p.name}\\n${stack ? stack.stack : ''}\\n\\n`;\n                })\n                .join('\\n\\n')\n            : '';\n          const help =\n            'You may have multiple versions of the same plugin installed.\\n' +\n            'Ensure that `yarn list [the-plugin]` results in one version, ' +\n            'and use a yarn resolution or merge package version in your lock file to consolidate versions.\\n\\n';\n          throw new Error(\n            `${base}\\n\\n${meta}\\n\\n${suggestions && clue + suggestions + help}`\n          );\n        }\n      }\n\n      // Recursive: get the registered type and resolve it\n      resolving.add(getTokenRef(token));\n\n      function resolvePlugin(plugin) {\n        const registeredDeps = (plugin && plugin.deps) || {};\n        const resolvedDeps = {};\n        for (const key in registeredDeps) {\n          const registeredToken = registeredDeps[key];\n          resolvedDeps[key] = resolveToken(registeredToken, aliases);\n        }\n        // `provides` should be undefined if the plugin does not have a `provides` function\n        let provides =\n          plugin && plugin.provides ? plugin.provides(resolvedDeps) : undefined;\n        if (plugin && plugin.middleware) {\n          resolvedPlugins.push(plugin.middleware(resolvedDeps, provides));\n        }\n        return provides;\n      }\n\n      let provides = value;\n      if (value && value.__plugin__) {\n        provides = resolvePlugin(provides);\n        if (value.cleanup) {\n          this.cleanups.push(function() {\n            return typeof value.cleanup === 'function'\n              ? value.cleanup(provides)\n              : Promise.resolve();\n          });\n        }\n      } else {\n        nonPluginTokens.add(token);\n      }\n\n      if (enhancers && enhancers.length) {\n        enhancers.forEach(e => {\n          let nextProvides = e(provides);\n          appliedEnhancers.push([e, nextProvides]);\n          if (nextProvides && nextProvides.__plugin__) {\n            // if the token has a plugin enhancer, allow it to be registered with no dependents\n            nonPluginTokens.delete(token);\n            if (nextProvides.deps) {\n              Object.values(nextProvides.deps).forEach(token =>\n                this._dependedOn.add(getTokenRef(token))\n              );\n            }\n            nextProvides = resolvePlugin(nextProvides);\n          }\n          provides = nextProvides;\n        });\n      }\n      resolved.set(getTokenRef(token), provides);\n      resolving.delete(getTokenRef(token));\n      return provides;\n    };\n\n    for (let i = 0; i < this.plugins.length; i++) {\n      resolveToken(this.plugins[i]);\n    }\n    for (const token of nonPluginTokens) {\n      if (\n        token !== ElementToken &&\n        token !== RenderToken &&\n        !this._dependedOn.has(getTokenRef(token))\n      ) {\n        throw new Error(\n          `Registered token without depending on it: \"${token.name}\"`\n        );\n      }\n    }\n\n    this.plugins = resolvedPlugins;\n    this._getService = token => resolved.get(getTokenRef(token));\n  }\n  getService<TResolved>(token: Token<TResolved>): any {\n    if (!this._getService) {\n      throw new Error('Cannot get service from unresolved app');\n    }\n    return this._getService(token);\n  }\n}\n\n/* Helper functions */\nfunction getTokenRef(token) {\n  if (token instanceof TokenImpl) {\n    return token.ref;\n  }\n  return token;\n}\n\nexport default FusionApp;\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport type {Middleware} from './types.js';\n\n// inline version of koa-compose to get around Rollup/CUP commonjs-related issue\nexport function compose(middleware: Array<Middleware>): Middleware {\n  if (!Array.isArray(middleware)) {\n    throw new TypeError('Middleware stack must be an array!');\n  }\n  for (const fn of middleware) {\n    if (typeof fn !== 'function') {\n      throw new TypeError(\n        `Expected middleware function, received: ${typeof fn}`\n      );\n    }\n  }\n\n  return function(context, next) {\n    let index = -1;\n    return dispatch(0);\n    function dispatch(i) {\n      if (i <= index) {\n        return Promise.reject(new Error('next() called multiple times'));\n      }\n      index = i;\n      let fn = middleware[i];\n      if (i === middleware.length) fn = next;\n      if (!fn) return Promise.resolve();\n      try {\n        return fn(context, function next() {\n          return dispatch(i + 1);\n        });\n      } catch (err) {\n        return Promise.reject(err);\n      }\n    }\n  };\n}\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport type {Context} from './types.js';\n\ntype MemoizeFn<A> = (ctx: Context) => A;\n\nfunction Container() {}\n\nexport function memoize<A>(fn: MemoizeFn<A>): MemoizeFn<A> {\n  const memoizeKey = __NODE__ ? Symbol('memoize-key') : new Container();\n  return function memoized(ctx: Context) {\n    if (ctx.memoized.has(memoizeKey)) {\n      return ctx.memoized.get(memoizeKey);\n    }\n    const result = fn(ctx);\n    ctx.memoized.set(memoizeKey, result);\n    return result;\n  };\n}\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\nimport {createPlugin} from '../create-plugin';\nimport {memoize} from '../memoize';\nimport {createToken} from '../create-token';\nimport type {Token} from '../types.js';\n\ntype Deferred<T> = {\n  promise: Promise<T>,\n  resolve: (result: T) => void,\n  reject: (error: Error) => void,\n};\n\nclass Timing {\n  start: number;\n  render: Deferred<number>;\n  end: Deferred<number>;\n  downstream: Deferred<number>;\n  upstream: Deferred<number>;\n  upstreamStart: number;\n  constructor() {\n    this.start = now();\n    this.render = deferred();\n    this.end = deferred();\n    this.downstream = deferred();\n    this.upstream = deferred();\n    this.upstreamStart = -1;\n  }\n}\ntype TimingPlugin = {\n  from(ctx: Object): Timing,\n};\n\nconst timing: TimingPlugin = {\n  from: memoize(() => new Timing()),\n};\n\nexport const TimingToken: Token<TimingPlugin> = createToken('TimingToken');\n\nfunction middleware(ctx, next) {\n  ctx.memoized = new Map();\n  const {start, render, end, downstream, upstream} = timing.from(ctx);\n  ctx.timing = {\n    start,\n    render: render.promise,\n    end: end.promise,\n    downstream: downstream.promise,\n    upstream: upstream.promise,\n  };\n  return next()\n    .then(() => {\n      const upstreamTime = now() - timing.from(ctx).upstreamStart;\n      upstream.resolve(upstreamTime);\n      const endTime = now() - ctx.timing.start;\n      end.resolve(endTime);\n    })\n    .catch(e => {\n      // currently we only resolve upstream and downstream when the request does not error\n      // we should however always resolve the request end timing\n      if (e && e.status) {\n        // this ensures any logging / metrics based on ctx.status will recieve the correct status code\n        ctx.status = e.status;\n      }\n      const endTime = now() - ctx.timing.start;\n      end.resolve(endTime);\n      throw e;\n    });\n}\n\nexport default createPlugin<{}, typeof timing>({\n  provides: () => timing,\n  middleware: () => middleware,\n});\n\nexport function now(): number {\n  if (__NODE__) {\n    const [seconds, ns] = process.hrtime();\n    return Math.round(seconds * 1000 + ns / 1e6);\n  } else {\n    // eslint-disable-next-line cup/no-undef\n    if (window.performance && window.performance.now) {\n      // eslint-disable-next-line cup/no-undef\n      return Math.round(window.performance.now());\n    }\n    return Date.now();\n  }\n}\n\nfunction deferred<T>(): Deferred<T> {\n  let resolve = () => {};\n  let reject = () => {};\n  const promise = new Promise((res, rej) => {\n    resolve = res;\n    reject = rej;\n  });\n  return {\n    promise,\n    resolve,\n    reject,\n  };\n}\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport {now} from './timing';\n\nimport type {Context} from '../types.js';\n\nexport default function getRendererPlugin({\n  render,\n  timing,\n}: {\n  render: any,\n  timing: any,\n}) {\n  return async function renderer(ctx: Context, next: () => Promise<void>) {\n    const timer = timing.from(ctx);\n    timer.downstream.resolve(now() - timer.start);\n\n    let renderTime = null;\n    if (ctx.element && !ctx.body && ctx.respond !== false) {\n      const renderStart = now();\n      ctx.rendered = await render(ctx.element, ctx);\n      renderTime = now() - renderStart;\n    }\n\n    timer.upstreamStart = now();\n    await next();\n\n    if (ctx.element && typeof renderTime === 'number') {\n      timer.render.resolve(renderTime);\n    }\n  };\n}\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n/* eslint-env node */\nimport assert from 'assert';\n\nexport default (__BROWSER__ ? () => {} : loadEnv());\n\nfunction load(key, value) {\n  return process.env[key] || value;\n}\n\nexport function loadEnv() {\n  const rootDir = load('ROOT_DIR', '.');\n  const env = load('NODE_ENV', 'development');\n  if (!(env === 'development' || env === 'production' || env === 'test')) {\n    throw new Error(`Invalid NODE_ENV loaded: ${env}.`);\n  }\n  const prefix = load('ROUTE_PREFIX', '');\n  assert(!prefix.endsWith('/'), 'ROUTE_PREFIX must not end with /');\n  const baseAssetPath = load('FRAMEWORK_STATIC_ASSET_PATH', `/_static`);\n  assert(\n    !baseAssetPath.endsWith('/'),\n    'FRAMEWORK_STATIC_ASSET_PATH must not end with /'\n  );\n  const cdnUrl = load('CDN_URL', '');\n  assert(!cdnUrl.endsWith('/'), 'CDN_URL must not end with /');\n\n  const assetPath = `${prefix}${baseAssetPath}`;\n  return function loadEnv(): Env {\n    return {\n      rootDir,\n      env,\n      prefix,\n      assetPath,\n      baseAssetPath,\n      cdnUrl,\n      webpackPublicPath: cdnUrl || assetPath,\n    };\n  };\n}\n\n// Handle flow-types for export so browser export is ignored.\ntype Env = {\n  rootDir: string,\n  env: string,\n  prefix: string,\n  assetPath: string,\n  baseAssetPath: string,\n  cdnUrl: string,\n  webpackPublicPath: string,\n};\ndeclare export default () => Env;\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport uuidv4 from 'uuid/v4';\nimport UAParser from 'ua-parser-js';\nimport getEnv from '../get-env.js';\n\nimport type {Context} from '../types.js';\n\nconst envVars = getEnv();\n\nexport default function middleware(ctx: Context, next: () => Promise<void>) {\n  // env vars\n  ctx.rootDir = envVars.rootDir;\n  ctx.env = envVars.env;\n  ctx.prefix = envVars.prefix;\n  ctx.assetPath = envVars.assetPath;\n  ctx.cdnUrl = envVars.cdnUrl;\n\n  // webpack-related things\n  ctx.preloadChunks = [];\n  ctx.webpackPublicPath =\n    ctx.webpackPublicPath || envVars.cdnUrl || envVars.assetPath;\n\n  // these are set by fusion-cli, however since fusion-cli plugins are not added when\n  // running simulation tests, it is good to default them here\n  ctx.syncChunks = ctx.syncChunks || [];\n  ctx.chunkUrlMap = ctx.chunkUrlMap || new Map();\n\n  // fusion-specific things\n  ctx.nonce = uuidv4();\n  ctx.useragent = new UAParser(ctx.headers['user-agent']).getResult();\n  ctx.element = null;\n  ctx.rendered = null;\n\n  return next();\n}\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n/* eslint-env node */\nimport {compose} from './compose.js';\nimport Timing, {TimingToken} from './plugins/timing';\nimport BaseApp from './base-app';\nimport serverRenderer from './plugins/server-renderer';\nimport {\n  RenderToken,\n  ElementToken,\n  SSRDeciderToken,\n  SSRBodyTemplateToken,\n} from './tokens';\nimport ssrPlugin from './plugins/ssr';\nimport contextMiddleware from './plugins/server-context.js';\n\nexport default function(): typeof BaseApp {\n  const Koa = require('koa');\n\n  return class ServerApp extends BaseApp {\n    _app: Koa;\n    constructor(el, render) {\n      super(el, render);\n      this._app = new Koa();\n      this._app.proxy = true;\n      this.middleware(contextMiddleware);\n      this.register(TimingToken, Timing);\n      this.middleware(\n        {\n          element: ElementToken,\n          ssrDecider: SSRDeciderToken,\n          ssrBodyTemplate: SSRBodyTemplateToken.optional,\n        },\n        ssrPlugin\n      );\n    }\n    resolve() {\n      this.middleware(\n        {timing: TimingToken, render: RenderToken},\n        serverRenderer\n      );\n      return super.resolve();\n    }\n    callback() {\n      this.resolve();\n      this._app.use(compose(this.plugins));\n      return this._app.callback();\n    }\n  };\n}\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\n/* eslint-env browser */\n\nimport type {Context} from '../types.js';\n\nexport default function createClientHydrate({element}: {element: any}) {\n  return function clientHydrate(ctx: Context, next: () => Promise<void>) {\n    ctx.prefix = window.__ROUTE_PREFIX__ || ''; // serialized by ./server\n    ctx.element = element;\n    ctx.preloadChunks = [];\n    return next();\n  };\n}\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport type {Context} from '../types.js';\n\nexport default function createClientRenderer({render}: {render: any}) {\n  return function renderer(ctx: Context, next: () => Promise<void>) {\n    const rendered = render(ctx.element, ctx);\n    if (rendered instanceof Promise) {\n      return rendered.then(r => {\n        ctx.rendered = r;\n        return next();\n      });\n    } else {\n      ctx.rendered = rendered;\n      return next();\n    }\n  };\n}\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n/* eslint-env browser */\nimport {compose} from './compose.js';\nimport timing, {TimingToken} from './plugins/timing';\nimport BaseApp from './base-app';\nimport createClientHydrate from './plugins/client-hydrate';\nimport createClientRenderer from './plugins/client-renderer';\nimport {RenderToken, ElementToken} from './tokens';\n\nexport default function(): typeof BaseApp {\n  return class ClientApp extends BaseApp {\n    constructor(el, render) {\n      super(el, render);\n      this.register(TimingToken, timing);\n      this.middleware({element: ElementToken}, createClientHydrate);\n    }\n    resolve() {\n      this.middleware({render: RenderToken}, createClientRenderer);\n      return super.resolve();\n    }\n    callback() {\n      this.resolve();\n      const middleware = compose(this.plugins);\n      return () => {\n        // TODO(#62): Create noop context object to match server api\n        const ctx: any = {\n          url: window.location.path + window.location.search,\n          element: null,\n          body: null,\n        };\n        return middleware(ctx, () => Promise.resolve()).then(() => ctx);\n      };\n    }\n  };\n}\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nexport function assetUrl(url: string): string {\n  /**\n   * PLEASE NOTE: a build step transforms\n   * the arguments provided to this function\n   */\n  return url;\n}\n\nexport function chunkId(filename: string): string {\n  /**\n   * PLEASE NOTE: a build step transforms\n   * the arguments provided to this function\n   */\n  return filename;\n}\n\nexport function syncChunkIds(argument: any): any {\n  /**\n   * PLEASE NOTE: a build step transforms\n   * the arguments provided to this function\n   */\n  return argument;\n}\n\nexport function syncChunkPaths(argument: any): any {\n  /**\n   * PLEASE NOTE: a build step transforms\n   * the arguments provided to this function\n   */\n  return argument;\n}\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\nimport type {\n  Context,\n  FusionPlugin,\n  Middleware,\n  Token,\n  SSRBodyTemplate,\n  RenderType as Render,\n} from './types.js';\n\nimport BaseApp from './base-app';\nimport serverApp from './server-app';\nimport clientApp from './client-app';\nimport getEnv from './get-env.js';\n\nexport default (__BROWSER__ ? clientApp() : serverApp());\n\nexport {compose} from './compose.js';\nexport {memoize} from './memoize';\n\n// sanitization API\nexport {\n  html,\n  dangerouslySetHTML,\n  consumeSanitizedHTML,\n  escape,\n  unescape,\n} from './sanitization';\n\n// Virtual modules\nexport {\n  assetUrl,\n  chunkId,\n  syncChunkIds,\n  syncChunkPaths,\n} from './virtual/index.js';\n\nexport {\n  RenderToken,\n  ElementToken,\n  SSRDeciderToken,\n  HttpServerToken,\n  SSRBodyTemplateToken,\n  RoutePrefixToken,\n  CriticalChunkIdsToken,\n} from './tokens';\nexport {createPlugin} from './create-plugin';\nexport {createToken} from './create-token';\nexport {getEnv};\n\ntype FusionApp = typeof BaseApp;\ndeclare export default typeof BaseApp;\nexport type {\n  Context,\n  FusionApp,\n  FusionPlugin,\n  Middleware,\n  Token,\n  SSRBodyTemplate,\n  Render,\n};\n"],"names":["createPlugin","opts","__plugin__","stack","Error","TokenType","Object","freeze","Required","Optional","Ref","TokenImpl","constructor","name","ref","type","stacks","optional","createToken","RenderToken","ElementToken","SSRDeciderToken","HttpServerToken","SSRBodyTemplateToken","RoutePrefixToken","CriticalChunkIdsToken","html","dangerouslySetHTML","consumeSanitizedHTML","escape","forbiddenChars","replaceForbidden","c","key","Symbol","head","rest","values","obj","defineProperty","enumerable","configurable","value","map","s","i","join","str","String","replace","h","replaceEscaped","fromCodePoint","parseInt","slice","unescape","flowHtml","flowDangerouslySetHTML","flowConsumeSanitizedHTML","flowEscape","botRegex","SSRDecider","provides","ctx","path","match","headers","agent","test","accept","includes","createSSRPlugin","element","ssrDecider","ssrBodyTemplate","ssrPlugin","next","template","htmlAttrs","bodyAttrs","title","body","rendered","respond","legacySSRBodyTemplate","safeAttrs","keys","attrKey","safeBodyAttrs","safeTitle","safeHead","safeBody","preloadHintLinks","getPreloadHintLinks","coreGlobals","getCoreGlobals","chunkScripts","getChunkScripts","bundleSplittingBootstrap","webpackPublicPath","nonce","JSON","stringify","prefix","getUrls","chunkUrlMap","chunks","isCrossOrigin","startsWith","crossOriginAttribute","Set","id","url","get","endsWith","sync","syncChunks","preloaded","preloadChunks","filter","item","hints","FusionApp","el","render","register","tokenOrValue","maybeValue","hasToken","token","renderer","alias","push","_register","registered","Map","enhancerToToken","_dependedOn","plugins","cleanups","aliases","enhancers","getTokenRef","deps","forEach","add","set","sourceToken","destToken","middleware","undefined","enhance","enhancer","Array","isArray","cleanup","Promise","all","fn","resolve","resolved","nonPluginTokens","resolving","resolvedPlugins","appliedEnhancers","resolveToken","tokenAliases","has","newToken","dependents","from","entries","findDependentTokens","entry","findDependentEnhancers","enhancedToken","dependentTokens","base","downstreams","find","t","meta","clue","suggestions","p","help","resolvePlugin","plugin","registeredDeps","resolvedDeps","registeredToken","length","e","nextProvides","delete","_getService","getService","compose","TypeError","context","index","dispatch","reject","err","memoize","memoizeKey","memoized","result","Timing","start","now","deferred","end","downstream","upstream","upstreamStart","timing","TimingToken","promise","then","upstreamTime","endTime","catch","status","seconds","ns","process","hrtime","Math","round","res","rej","getRendererPlugin","timer","renderTime","renderStart","loadEnv","load","env","rootDir","assert","baseAssetPath","cdnUrl","assetPath","envVars","getEnv","uuidv4","useragent","UAParser","getResult","Koa","require","ServerApp","BaseApp","_app","proxy","contextMiddleware","serverRenderer","callback","use","assetUrl","chunkId","filename","syncChunkIds","argument","syncChunkPaths","serverApp"],"mappings":"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"}